DRV_SRCS =	compute_engine.c \
		file_converter.c \
		start_analysis.c

BAS_SRCS =	main.c \
		auxiliary.c \
		control_parameter.c \
		cosmology.c \
		system.c \
		times.c \
		units.c

COR_SRCS =	agn.c \
		cache.c \
		cell_buffer.c \
		config.c \
		cooling.c \
		density.c \
		gravity.c \
		hydro.c \
		hydro_tracer.c \
		index_hash.c \
		io.c \
		io_cart.c \
		io_cartio.c \
		iterators.c \
		load_balance.c \
		oct_hash.c \
		pack.c \
		parallel.c \
		particle.c \
		particle_buffer.c \
		plugin.c \
		rand.c \
		refinement.c \
		refinement_indicators.c \
		refinement_operations.c \
		riemann.c \
		root_grid_fft.c \
		rt.c \
		rt_debug.c \
		rt_global.c \
		rt_io.c \
		rt_otvet.c \
		rt_transfer.c \
		sfc.c \
		skiplist.c \
		starformation.c \
		starformation_feedback.c \
		starformation_recipes.c \
		timing.c \
		tree.c \
		tree_arrays.c \
		tree_alloc.c \
		tree_count.c \
		tree_debug.c \
		tree_interpolate.c \
		tree_linkedlist.c

FRT_SRCS =	frt_background.F \
		frt_base.F \
		frt_cf3.F \
		frt_cooling.F \
		frt_cooling_solvers.F \
		frt_global.F \
		frt_io.F \
		frt_lwbands.F \
		frt_mpi.F \
		frt_spectrum.F \
		frt_tables.F \
		frt_testing.F \
		frt_transfer.F \
		frt_xrays.F

FFT_SRCS  =	fft3.c \
		ffti_pack.c

CIO_SRCS =	cartio.c \
		cartio_grid.c \
		cartio_particle.c \
		cartio_mpi.c \
		cartio_posix.c \
		cartio_parameter.c \
		cartio_endian.c

RUN_SRCS  =	gravity_step.c \
		hydro_step.c \
		hydro_tracer_step.c \
		io_step.c \
		logging.c \
		particle_step.c \
		rt_step.c \
		rt_otvet_step.c \
		rt_transfer_step.c \
		starformation_feedback_step.c \
		starformation_step.c \
		step.c

EXT_SRCS  =	cd.c \
		chull.c \
		gic_tools.c \
		halo_finder.c \
		hart_io.c \
		healpix.c \
		ifrit.c \
		igm.c \
		ism.c \
		los.c \
		mesh.c \
		power.c \
		rfsfr.c \
		utils.c \
		viewdump.c \
		xrays.c \
		output_slice.c

DRV_OBJS =	$(patsubst %.c,.obj/%.o,$(DRV_SRCS))
BAS_OBJS =	$(patsubst %.c,.obj/%.o,$(BAS_SRCS))
COR_OBJS =	$(patsubst %.c,.obj/%.o,$(COR_SRCS))
FRT_OBJS =	$(patsubst %.F,.obj/%.o,$(FRT_SRCS))
FFT_OBJS =	$(patsubst %.c,.obj/%.o,$(FFT_SRCS))
CIO_OBJS = 	$(patsubst %.c,.obj/%.o,$(CIO_SRCS))
RUN_OBJS =	$(patsubst %.c,.obj/%.o,$(RUN_SRCS))
EXT_OBJS = 	$(patsubst %.c,.obj/%.o,$(EXT_SRCS))

LIBC_SRCS  =
LIBF_SRCS  =	fftpack.f

LIBC_OBJS =	$(patsubst %.c,.obj/%.o,$(LIBC_SRCS))
LIBF_OBJS =	$(patsubst %.f,.obj/%.o,$(LIBF_SRCS))
LIB_OBJS  =     $(LIBC_OBJS) $(LIBF_OBJS)


SIM_OBJS    =	$(BAS_OBJS) $(COR_OBJS) $(FRT_OBJS) $(FFT_OBJS) $(LIB_OBJS) $(CIO_OBJS) $(RUN_OBJS) .obj/compute_engine.o
ANL_OBJS    =	$(BAS_OBJS) $(COR_OBJS) $(FRT_OBJS) $(FFT_OBJS) $(LIB_OBJS) $(CIO_OBJS) $(EXT_OBJS) .obj/compute_engine.o .obj/start_analysis.o
FIC_OBJS    =	$(BAS_OBJS) $(COR_OBJS) $(FRT_OBJS) $(FFT_OBJS) $(LIB_OBJS) $(CIO_OBJS) .obj/file_converter.o


ifndef FRODO_LIVES
$(error TRUNK IS BROKEN AND SHOULD NOT BE USED!!!!)
endif


ifdef PLATFORM
include $(TOP_DIR)/platforms/$(PLATFORM)
else
list := $(shell ls -m $(TOP_DIR)/platforms)
$(info A variable PLATFORM must be set. Available platforms:)
$(info $(list))
$(error Fatal error)
endif

ifndef CC
$(info A variable CC must be set in the platform file.)
$(error Fatal error)
endif

ifndef F77
ifdef FC
F77 = $(FC)
endif
endif

ifndef F77
$(info A variable F77 must be set in the platform file.)
$(error Fatal error)
endif

ifndef CFLAGS
$(info A variable CFLAGS must be set in the platform file.)
$(error Fatal error)
endif

ifndef FFLAGS
$(info A variable CC must be set in the platform file.)
$(error Fatal error)
endif

ifndef CXX
$(info A variable CXX must be set in the platform file.)
$(error Fatal error)
endif

ifndef CXXFLAGS
CXXFLAGS = $(CFLAGS)
endif

LIBS    = -lgsl -lgslcblas -lm

DEFS = defs.h
defs.h:	
	@echo "Configuration file defs.h must be set. Available templates:"
	@ls -1 $(TOP_DIR)/config/defs.*
	@cat $(TOP_DIR)/platforms >& /dev/null

WITH_RT = $(shell fgrep RADIATIVE_TRANSFER defs.h)

ifneq ($(strip $(WITH_RT)),)
DEFS += rt_defs.h
rt_defs.h:	
	@echo "Configuration file rt_defs.h must be set. Available templates:"
	@ls -1 $(TOP_DIR)/config/rt_defs.*
	@cat $(TOP_DIR)/platforms >& /dev/null
endif

.obj/.phony:
	mkdir .obj
	echo "aaa" > .obj/.phony

.obj/%.o: .obj/.phony $(DEFS) $(SRC_DIR)/drivers/%.c
	$(CC)  -c $(CFLAGS) $(INCLUDES) -I. -I$(SRC_DIR)/base -o $@ $(SRC_DIR)/drivers/$(*F).c

.obj/%.o: .obj/.phony $(DEFS) $(SRC_DIR)/base/%.c
	$(CC)  -c $(CFLAGS) $(INCLUDES) -I. -I$(SRC_DIR)/base -o $@ $(SRC_DIR)/base/$(*F).c

.obj/%.o: .obj/.phony $(DEFS) $(SRC_DIR)/core/%.c
	$(CC)  -c $(CFLAGS) $(INCLUDES) -I. -I$(SRC_DIR)/base -I$(SRC_DIR)/core -o $@ $(SRC_DIR)/core/$(*F).c

.obj/config.o: .obj/.phony $(DEFS) $(TOP_DIR)/config/list_defines.h $(SRC_DIR)/core/config.c
	$(CC)  -c $(CFLAGS) $(INCLUDES) \
	-DSVNREVISION="\"`svnversion -n $(TOP_DIR)`\"" \
	-DSVNBRANCH="\"`svn info $(TOP_DIR) | sed -ne 's#^URL: https://www.drudd.com/svn/cart/##p'`\"" \
	-I. -I$(SRC_DIR)/base -I$(SRC_DIR)/core -o $@ $(SRC_DIR)/core/$(*F).c

.obj/io_cart.o: .obj/.phony $(DEFS) $(SRC_DIR)/core/io_cart.c $(SRC_DIR)/core/io_cart1.def $(SRC_DIR)/core/io_cart2.def
	$(CC)  -c $(CFLAGS) $(INCLUDES) -I. -I$(SRC_DIR)/base -I$(SRC_DIR)/core -o $@ $(SRC_DIR)/core/$(*F).c

.obj/%.o: .obj/.phony $(DEFS) $(SRC_DIR)/base/rt_config.h $(SRC_DIR)/core/frt/%.F
	$(F77) -c $(FFLAGS) $(INCLUDES) -I. -I$(SRC_DIR)/base -I$(SRC_DIR)/core/frt -o $@ $(SRC_DIR)/core/frt/$(*F).F

.obj/%.o: .obj/.phony $(DEFS) $(SRC_DIR)/tools/fft/%.c
	$(CC) -c $(CFLAGS) $(INCLUDES) -I. -I$(SRC_DIR)/base -I$(SRC_DIR)/tools/fft -o $@ $(SRC_DIR)/tools/fft/$(*F).c

.obj/%.o: .obj/.phony $(DEFS) $(SRC_DIR)/tools/cartio/%.c
	$(CC) -c $(CFLAGS) $(INCLUDES) -I. -I$(SRC_DIR)/tools/cartio -DCARTIO_MPI -o $@ $(SRC_DIR)/tools/cartio/$(*F).c

.obj/%.o: .obj/.phony $(DEFS) $(SRC_DIR)/run/%.c
	$(CC) -c $(CFLAGS) $(INCLUDES) -I. -I$(SRC_DIR)/base -I$(SRC_DIR)/core -o $@ $(SRC_DIR)/run/$(*F).c

.obj/%.o: .obj/.phony $(DEFS) $(SRC_DIR)/extra/%.c
	$(CC) -c $(CFLAGS) $(INCLUDES) -I. -I$(SRC_DIR)/base -I$(SRC_DIR)/core -o $@ $(SRC_DIR)/extra/$(*F).c

.obj/%.o: .obj/.phony $(SRC_DIR)/tools/other/%.f
	$(F77) -c $(FFLAGS) -I$(SRC_DIR)/tools/other -o $@ $(SRC_DIR)/tools/other/$(*F).f

.obj/%.o: .obj/.phony $(SRC_DIR)/tools/other/%.c
	$(CC) -c $(CFLAGS) -I$(SRC_DIR)/tools/other -o $@ $(SRC_DIR)/tools/other/$(*F).c

$(info **********************************************)
$(info *                                            *)
$(info *          Adaptive Refinement Tree          *)
$(info *                                            *)
$(info **********************************************)
$(info Compiling for platform: $(PLATFORM))
